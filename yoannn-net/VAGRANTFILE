# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.provider "virtualbox" do |vb|
    vb.gui = false
    vb.memory = "1024"
    vb.cpus = 1
  end

  config.ssh.insert_key = false
  config.vm.boot_timeout = 600
  config.vm.box_check_update = false

  # Define the edge-router VM
  config.vm.define "edge-router" do |router|
    router.vm.box = "debian/bullseye64"
    router.vm.hostname = "edge-router"
    router.vm.network "private_network", ip: "10.0.0.1", virtualbox__intnet: "WAN"
    router.vm.network "private_network", ip: "192.169.1.1", virtualbox__intnet: "DMZ"
    router.vm.network "private_network", ip: "42.42.42.1", virtualbox__intnet: "LAN"
    #router.vm.network "forwarded_port", guest: 80, host: 8088 

    router.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y nftables nginx
      systemctl enable nftables
      #systemctl start nftables

      # Load the nftables rules
      #nft -f /etc/nftables.conf

      # Enable IP forwarding
      echo 1 > /proc/sys/net/ipv4/ip_forward
      echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
      sysctl -p

      # Setup nginx
      mkdir -p /etc/nginx/conf.d

      cat > /etc/nginx/nginx.conf <<EOL
      user www-data;
      worker_processes auto;
      error_log /var/log/nginx/error.log;
      pid /run/nginx.pid;

      events {
          worker_connections 1024;
      }

      http {
          include             /etc/nginx/mime.types;
          default_type        application/octet-stream;

          include /etc/nginx/conf.d/*.conf;
      }
EOL

      cat > /etc/nginx/conf.d/default.conf <<'EOL'
      server {
          listen 80 default_server;
          server_name _;

          location / {
              return 404;
          }
      }
EOL

      cat > /etc/nginx/conf.d/web1.conf <<'EOL'
      server {
          listen 80;
          server_name web1.yfrancois.webserver.com;

          location / {
              proxy_pass http://192.169.1.20:8081;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }
EOL

      cat > /etc/nginx/conf.d/web2.conf <<'EOL'
      server {
          listen 80;
          server_name web2.yfrancois.webserver.com;

          location / {
              proxy_pass http://192.169.1.20:8082;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }
EOL

      cat > /etc/nginx/conf.d/edgeshark.conf <<'EOL'
      server {
          listen 80;
          server_name edgeshark.yfrancois.webserver.com;

          location / {
              proxy_pass http://192.169.1.20:5001;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }
EOL
      # Restart nginx to apply the new configuration
      systemctl restart nginx
      echo "nameserver 192.169.1.20" > /etc/resolv.conf
      ip route del default
    SHELL
  end

  # Define the services VM with Edgeshark and other services.
  config.vm.define "services" do |services|
    services.vm.box = "debian/bullseye64"
    services.vm.hostname = "services"
    services.vm.network "private_network", ip: "192.169.1.20", virtualbox__intnet: "DMZ"

    # Set up port forwarding for services in this VM.
    services.vm.network "forwarded_port", guest: 80, host: 8080 # For webserver (Apache)
    services.vm.network "forwarded_port", guest: 8081, host: 8081 # For web1 (Nginx)
    services.vm.network "forwarded_port", guest: 8082, host: 8082 # For web2 (Nginx)
    services.vm.network "forwarded_port", guest: 5001, host: 5001 # For Edgeshark

    services.vm.provision "shell", inline: <<-SHELL
      # Update and install necessary packages.
      apt-get update && apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release docker.io bind9 bind9utils bind9-doc

      # Add vagrant user to the docker group.
      usermod -aG docker vagrant
      
      # Create necessary directories for services.
      mkdir -p /home/vagrant/services/web1 /home/vagrant/services/web2 /home/vagrant/services/webserver

      # Create necessary directories for BIND configuration.
      mkdir -p /etc/bind/zones
      
      # Add routes for WAN and LAN networks and default gateway.
      ip route add 10.0.0.0/24 via 192.169.1.1
      ip route add 42.42.42.0/24 via 192.169.1.1
      ip route add add 192.169.1.0/24 via 192.169.1.1

      # Install Edgeshark using the provided bash script instead of Docker Compose.
      wget -q --no-cache -O /tmp/edgeshark.sh https://github.com/siemens/edgeshark/raw/main/deployments/nocomposer/edgeshark.sh
      chmod +x /tmp/edgeshark.sh
      
      # Run Edgeshark installation script.
      if ! DOCKER_DEFAULT_PLATFORM= bash /tmp/edgeshark.sh up; then
          echo "Edgeshark installation failed."
          exit 1
      fi

      # Start the web1 container (Nginx).
      if ! docker run -d --name web1 -p 8081:80 -v /home/vagrant/services/web1:/usr/share/nginx/html:ro nginx:alpine; then
          echo "Failed to start web1 container."
          exit 1
      fi

      # Start the web2 container (Nginx).
      if ! docker run -d --name web2 -p 8082:80 -v /home/vagrant/services/web2:/usr/share/nginx/html:ro nginx:alpine; then
          echo "Failed to start web2 container."
          exit 1
      fi

      # Start the webserver container (Apache).
      if ! docker run -d --name webserver -p 8080:80 -v /home/vagrant/services/webserver:/usr/local/apache2/htdocs/ httpd:2.4; then
          echo "Failed to start webserver container."
          exit 1
      fi

      # Create index.html files for each service.
      echo "<h1>Welcome to Web1</h1>" > /home/vagrant/services/web1/index.html 
      echo "<h1>Welcome to Web2</h1>" > /home/vagrant/services/web2/index.html 
      echo "<h1>Welcome to Web Server</h1>" > /home/vagrant/services/webserver/index.html 

      cat > /etc/bind/named.conf.local <<EOL
        zone "yfrancois.webserver.com" {
          type master;
          file "/etc/bind/db.yfrancois.webserver.com";
        };
EOL

      # Creating DNS Zone File
      #cp /etc/bind/db.local /etc/bind/db.yfrancois.webserver.com

      # Create db.example.com zone file
      cat > /etc/bind/db.yfrancois.webserver.com <<'EOL'
$TTL    604800
@       IN      SOA     yfrancois.webserver.com. admin.yfrancois.webserver.com. (
                        2023113001 ; Serial
                        604800     ; Refresh
                        86400      ; Retry
                        2419200    ; Expire
                        604800 )   ; Negative Cache TTL

; Nom de serveur DNS
@       IN      NS      ns.yfrancois.webserver.com.

; Adresse IP du serveur DNS
ns      IN      A       192.169.1.20

; Enregistrement pour yfrancois.webserver.com
@       IN      A       192.169.1.20

web1    IN     A        10.0.0.1 #192.169.1.20

web2    IN     A        10.0.0.1 #192.169.1.20

edgeshark IN   A        10.0.0.1 #192.169.1.20
EOL

# Create db.example.com zone file
cat > /etc/bind/named.conf.options <<EOL
\options {
    directory "/var/cache/bind";
    listen-on { 192.169.1.20; };
    allow-query { any; };
    recursion yes;
};
EOL

      # Restart BIND9 to apply changes
      #chown bind:bind /etc/bind/db.yfrancois.webserver.com
      #chmod 644 /etc/bind/zones/db.yfrancois.webserver.com
      # Change ownership to bind user and group
      sudo chown bind:bind /etc/bind/zones/db.yfrancois.webserver.com
      sudo chown bind:bind /etc/bind/named.conf.local

      # Set appropriate permissions
      sudo chmod 644 /etc/bind/zones/db.yfrancois.webserver.com
      sudo chmod 644 /etc/bind/named.conf.local
      systemctl restart bind9
      
      ip route del default
      ip route add default via 192.169.1.1

      #chown -R vagrant:vagrant /home/vagrant/services 
SHELL
  end

  # Define external client
  config.vm.define "external-client" do |client|
    client.vm.box = "bento/ubuntu-22.04"
    client.vm.hostname = "external-client"
    client.vm.network "private_network", ip: "10.0.0.100", virtualbox__intnet: "WAN"

    client.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y w3m curl dnsutils
      echo "nameserver 192.169.1.20" > /etc/resolv.conf
      ip route del default
      ip route add default via 10.0.0.1
      # Add routes for services
      ip route add 192.168.1.0/24 via 10.0.0.1

    SHELL
  end

  # Define LAN client
  config.vm.define "lan-client" do |client|
    client.vm.box = "debian/bullseye64"
    client.vm.hostname = "lan-client"
    client.vm.network "private_network", ip: "42.42.42.100", virtualbox__intnet: "LAN"

    client.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y curl w3m dnsutils
      echo "nameserver 192.169.1.20" > /etc/resolv.conf
      ip route del default
      ip route add default via 42.42.42.1
      # Add routes for services
      ip route add 192.168.1.0/24 via 42.42.42.1
    SHELL
  end
end
